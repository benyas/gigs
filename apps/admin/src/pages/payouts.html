<!-- title: Virements -->
<div x-data="payoutsPage()" x-init="load()">
  <div class="flex items-center justify-between mb-6">
    <div></div>
    <button @click="showCreate = true" class="btn-primary">+ Nouveau virement</button>
  </div>

  <template x-if="loading">
    <div class="text-center py-12 text-gray-400">Chargement...</div>
  </template>

  <template x-if="!loading">
    <div class="space-y-6">
      <!-- Stats cards -->
      <template x-if="stats">
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
          <div class="card">
            <p class="text-sm text-gray-500">En attente</p>
            <p class="text-2xl font-bold" x-text="stats.pendingPayouts"></p>
          </div>
          <div class="card">
            <p class="text-sm text-gray-500">Total verse</p>
            <p class="text-2xl font-bold text-green-600" x-text="(stats.totalPaidOut || 0).toFixed(2) + ' MAD'"></p>
          </div>
          <div class="card">
            <p class="text-sm text-gray-500">Soldes disponibles</p>
            <p class="text-2xl font-bold" x-text="(stats.totalAvailableBalance || 0).toFixed(2) + ' MAD'"></p>
          </div>
          <div class="card">
            <p class="text-sm text-gray-500">En escrow</p>
            <p class="text-2xl font-bold text-yellow-500" x-text="(stats.totalEscrowBalance || 0).toFixed(2) + ' MAD'"></p>
          </div>
        </div>
      </template>

      <!-- Filter -->
      <select x-model="statusFilter" @change="page = 1; loadPayouts()" class="select max-w-[180px]">
        <option value="">Tous les statuts</option>
        <option value="pending">En attente</option>
        <option value="processing">En cours</option>
        <option value="completed">Termines</option>
      </select>

      <!-- Table -->
      <template x-if="items.length === 0">
        <div class="text-center py-8 text-gray-400">Aucun virement.</div>
      </template>

      <template x-if="items.length > 0">
        <div class="table-container">
          <table class="w-full">
            <thead>
              <tr>
                <th class="th">Prestataire</th>
                <th class="th">Date</th>
                <th class="th">Montant</th>
                <th class="th">Statut</th>
                <th class="th text-right">Actions</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="p in items" :key="p.id">
                <tr>
                  <td class="td font-medium" x-text="p.provider?.profile?.name || p.providerId?.substring(0, 8)"></td>
                  <td class="td">
                    <div x-text="new Date(p.createdAt).toLocaleDateString('fr-MA')"></div>
                    <template x-if="p.processedAt">
                      <div class="text-xs text-gray-400" x-text="'Traite: ' + new Date(p.processedAt).toLocaleDateString('fr-MA')"></div>
                    </template>
                  </td>
                  <td class="td text-lg font-semibold" x-text="p.amount.toFixed(2) + ' MAD'"></td>
                  <td class="td">
                    <span :class="statusClass(p.status)" x-text="statusLabel(p.status)"></span>
                  </td>
                  <td class="td text-right">
                    <template x-if="p.status !== 'completed' && p.status !== 'failed'">
                      <button @click="complete(p)" class="btn-primary btn-sm" :disabled="completing === p.id">
                        <span x-text="completing === p.id ? '...' : 'Marquer termine'"></span>
                      </button>
                    </template>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </template>

      <template x-if="meta && meta.totalPages > 1">
        <div class="flex items-center justify-center gap-2 mt-4">
          <button @click="page--; loadPayouts()" :disabled="page <= 1" class="btn-secondary btn-sm">Precedent</button>
          <span class="text-sm text-gray-500" x-text="'Page ' + page + ' / ' + meta.totalPages"></span>
          <button @click="page++; loadPayouts()" :disabled="page >= meta.totalPages" class="btn-secondary btn-sm">Suivant</button>
        </div>
      </template>
    </div>
  </template>

  <!-- Create payout modal -->
  <template x-if="showCreate">
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40" @click.self="showCreate = false">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 m-4">
        <h2 class="text-lg font-bold mb-4">Nouveau virement</h2>
        <template x-if="createError">
          <div class="mb-3 rounded-lg bg-red-50 px-3 py-2 text-sm text-red-700" x-text="createError"></div>
        </template>
        <div class="space-y-3">
          <div>
            <label class="label">ID du prestataire</label>
            <input type="text" x-model="createForm.providerId" class="input" placeholder="ID du prestataire">
          </div>
          <div>
            <label class="label">Montant (MAD)</label>
            <input type="number" x-model="createForm.amount" class="input" placeholder="0.00">
          </div>
        </div>
        <div class="flex justify-end gap-2 mt-6">
          <button @click="showCreate = false" class="btn-secondary">Annuler</button>
          <button @click="createPayout()" class="btn-primary" :disabled="creating || !createForm.providerId || !createForm.amount">
            <span x-text="creating ? 'Creation...' : 'Creer'"></span>
          </button>
        </div>
      </div>
    </div>
  </template>
</div>

<script>
function payoutsPage() {
  return {
    items: [], meta: null, stats: null, loading: true, page: 1, statusFilter: '',
    completing: null, showCreate: false, creating: false, createError: '',
    createForm: { providerId: '', amount: '' },
    async load() {
      this.loading = true;
      try {
        const [payouts, stats] = await Promise.all([
          Alpine.store('api').get('/admin/payouts?page=' + this.page + (this.statusFilter ? '&status=' + this.statusFilter : '')),
          Alpine.store('api').get('/admin/payouts/stats'),
        ]);
        this.items = payouts.data;
        this.meta = payouts.meta;
        this.stats = stats;
      } catch (e) { console.error(e); }
      this.loading = false;
    },
    async loadPayouts() {
      try {
        const res = await Alpine.store('api').get('/admin/payouts?page=' + this.page + (this.statusFilter ? '&status=' + this.statusFilter : ''));
        this.items = res.data;
        this.meta = res.meta;
      } catch (e) { console.error(e); }
    },
    statusClass(s) {
      const m = { pending: 'badge-yellow', processing: 'badge-blue', completed: 'badge-green', failed: 'badge-red' };
      return m[s] || 'badge-gray';
    },
    statusLabel(s) {
      const m = { pending: 'En attente', processing: 'En cours', completed: 'Termine', failed: 'Echoue' };
      return m[s] || s;
    },
    async complete(p) {
      this.completing = p.id;
      try {
        await Alpine.store('api').patch('/admin/payouts/' + p.id);
        this.load();
      } catch (e) { alert(e.message); }
      this.completing = null;
    },
    async createPayout() {
      this.creating = true; this.createError = '';
      try {
        await Alpine.store('api').post('/admin/payouts', {
          providerId: this.createForm.providerId,
          amount: parseFloat(this.createForm.amount),
        });
        this.showCreate = false;
        this.createForm = { providerId: '', amount: '' };
        this.load();
      } catch (e) { this.createError = e.message; }
      this.creating = false;
    }
  };
}
</script>
