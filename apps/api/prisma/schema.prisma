generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  client
  provider
  admin
}

enum GigStatus {
  draft
  active
  paused
  archived
}

enum BookingStatus {
  pending
  accepted
  in_progress
  completed
  cancelled
  disputed
}

enum TransactionType {
  charge
  refund
  payout
  platform_fee
}

enum TransactionStatus {
  pending
  completed
  failed
}

enum PayoutStatus {
  pending
  processing
  completed
  failed
}

enum VerificationStatus {
  pending
  approved
  rejected
}

enum DisputeStatus {
  open
  under_review
  resolved_client
  resolved_provider
  closed
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  phone        String   @unique
  email        String?  @unique
  passwordHash String?  @map("password_hash")
  role         UserRole @default(client)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  profile         Profile?
  gigs            Gig[]
  bookingsAsClient Booking[] @relation("ClientBookings")
  reviewsGiven    Review[]  @relation("ReviewsGiven")
  reviewsReceived Review[]  @relation("ReviewsReceived")
  clientConversations   Conversation[] @relation("ClientConversations")
  providerConversations Conversation[] @relation("ProviderConversations")
  sentMessages    Message[]       @relation("SentMessages")
  notifications   Notification[]
  availability    Availability[]
  wallet          Wallet?
  transactions    Transaction[]
  payouts         Payout[]
  verificationDocs VerificationDocument[]
  disputes        Dispute[]
  favorites       Favorite[]
  pushSubscriptions PushSubscription[]
  referralsMade    Referral[]  @relation("Referrals")
  referredBy       Referral?   @relation("ReferredBy")
  portfolioItems   PortfolioItem[]

  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Profile {
  id         String  @id @default(uuid()) @db.Uuid
  userId     String  @unique @map("user_id") @db.Uuid
  name       String
  avatarUrl  String? @map("avatar_url")
  bio        String? @db.Text
  cityId     String? @map("city_id") @db.Uuid
  isVerified Boolean @default(false) @map("is_verified")
  ratingAvg  Float   @default(0) @map("rating_avg")
  ratingCount Int    @default(0) @map("rating_count")
  badges      Json?  @default("[]")

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  city City? @relation(fields: [cityId], references: [id])

  @@index([cityId])
  @@index([ratingAvg])
  @@map("profiles")
}

model City {
  id       String @id @default(uuid()) @db.Uuid
  name     String @unique
  region   String

  profiles Profile[]
  gigs     Gig[]

  @@index([region])
  @@map("cities")
}

model Category {
  id   String @id @default(uuid()) @db.Uuid
  name String @unique
  slug String @unique
  icon String

  gigs Gig[]

  @@map("categories")
}

model Gig {
  id          String    @id @default(uuid()) @db.Uuid
  providerId  String    @map("provider_id") @db.Uuid
  categoryId  String    @map("category_id") @db.Uuid
  title       String
  slug        String    @unique
  description String    @db.Text
  basePrice   Float     @map("base_price")
  cityId      String    @map("city_id") @db.Uuid
  status      GigStatus @default(draft)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  provider  User      @relation(fields: [providerId], references: [id], onDelete: Cascade)
  category  Category  @relation(fields: [categoryId], references: [id])
  city      City      @relation(fields: [cityId], references: [id])
  media     GigMedia[]
  bookings  Booking[]
  favorites Favorite[]

  @@index([providerId])
  @@index([categoryId])
  @@index([cityId])
  @@index([status])
  @@index([basePrice])
  @@index([createdAt])
  @@map("gigs")
}

model GigMedia {
  id        String @id @default(uuid()) @db.Uuid
  gigId     String @map("gig_id") @db.Uuid
  url       String
  sortOrder Int    @default(0) @map("sort_order")

  gig Gig @relation(fields: [gigId], references: [id], onDelete: Cascade)

  @@index([gigId])
  @@map("gig_media")
}

model Booking {
  id           String        @id @default(uuid()) @db.Uuid
  gigId        String        @map("gig_id") @db.Uuid
  clientId     String        @map("client_id") @db.Uuid
  scheduledAt  DateTime      @map("scheduled_at")
  address      String
  notes        String?       @db.Text
  status       BookingStatus @default(pending)
  totalPrice   Float         @map("total_price")
  discountAmount Float?      @map("discount_amount")
  couponCode   String?       @map("coupon_code")
  invoiceNumber Int?         @unique @map("invoice_number")
  cancelReason String?       @map("cancel_reason") @db.Text
  cancelledBy  String?       @map("cancelled_by") @db.Uuid
  cancelledAt  DateTime?     @map("cancelled_at")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  gig          Gig           @relation(fields: [gigId], references: [id])
  client       User          @relation("ClientBookings", fields: [clientId], references: [id])
  review       Review?
  conversation Conversation?
  transactions Transaction[]
  dispute      Dispute?

  @@index([gigId])
  @@index([clientId])
  @@index([status])
  @@index([scheduledAt])
  @@map("bookings")
}

model Review {
  id              String   @id @default(uuid()) @db.Uuid
  bookingId       String   @unique @map("booking_id") @db.Uuid
  clientId        String   @map("client_id") @db.Uuid
  providerId      String   @map("provider_id") @db.Uuid
  rating          Int
  comment         String   @db.Text
  providerReply   String?  @map("provider_reply") @db.Text
  providerReplyAt DateTime? @map("provider_reply_at")
  createdAt       DateTime @default(now()) @map("created_at")

  booking  Booking @relation(fields: [bookingId], references: [id])
  client   User    @relation("ReviewsGiven", fields: [clientId], references: [id])
  provider User    @relation("ReviewsReceived", fields: [providerId], references: [id])

  @@index([providerId])
  @@index([clientId])
  @@index([rating])
  @@map("reviews")
}

model Conversation {
  id        String   @id @default(uuid()) @db.Uuid
  bookingId String?  @unique @map("booking_id") @db.Uuid
  clientId  String   @map("client_id") @db.Uuid
  providerId String  @map("provider_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  booking  Booking?  @relation(fields: [bookingId], references: [id])
  client   User      @relation("ClientConversations", fields: [clientId], references: [id])
  provider User      @relation("ProviderConversations", fields: [providerId], references: [id])
  messages Message[]

  @@unique([clientId, providerId])
  @@index([clientId])
  @@index([providerId])
  @@index([updatedAt])
  @@map("conversations")
}

model Message {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @map("conversation_id") @db.Uuid
  senderId       String   @map("sender_id") @db.Uuid
  content        String   @db.Text
  isRead         Boolean  @default(false) @map("is_read")
  createdAt      DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SentMessages", fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  type      String
  title     String
  body      String   @db.Text
  link      String?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

model Availability {
  id         String @id @default(uuid()) @db.Uuid
  providerId String @map("provider_id") @db.Uuid
  dayOfWeek  Int    @map("day_of_week") // 0=Sunday, 6=Saturday
  startTime  String @map("start_time")  // "09:00"
  endTime    String @map("end_time")    // "18:00"
  isActive   Boolean @default(true) @map("is_active")

  provider User @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, dayOfWeek])
  @@index([providerId])
  @@map("availabilities")
}

model Wallet {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @unique @map("user_id") @db.Uuid
  balance        Float    @default(0)
  pendingBalance Float    @default(0) @map("pending_balance")
  totalEarned    Float    @default(0) @map("total_earned")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("wallets")
}

model Transaction {
  id          String            @id @default(uuid()) @db.Uuid
  bookingId   String?           @map("booking_id") @db.Uuid
  userId      String            @map("user_id") @db.Uuid
  type        TransactionType
  status      TransactionStatus @default(pending)
  amount      Float
  platformFee Float?            @map("platform_fee")
  cmiOrderId  String?           @map("cmi_order_id")
  metadata    Json?
  createdAt   DateTime          @default(now()) @map("created_at")

  booking Booking? @relation(fields: [bookingId], references: [id])
  user    User     @relation(fields: [userId], references: [id])

  @@index([bookingId])
  @@index([userId])
  @@index([type, status])
  @@index([cmiOrderId])
  @@map("transactions")
}

model Payout {
  id          String       @id @default(uuid()) @db.Uuid
  providerId  String       @map("provider_id") @db.Uuid
  amount      Float
  status      PayoutStatus @default(pending)
  processedBy String?      @map("processed_by") @db.Uuid
  processedAt DateTime?    @map("processed_at")
  bankDetails Json?        @map("bank_details")
  notes       String?      @db.Text
  createdAt   DateTime     @default(now()) @map("created_at")

  provider User @relation(fields: [providerId], references: [id])

  @@index([providerId])
  @@index([status])
  @@map("payouts")
}

model VerificationDocument {
  id           String             @id @default(uuid()) @db.Uuid
  userId       String             @map("user_id") @db.Uuid
  type         String             // "cin", "business_license", "diploma"
  fileUrl      String             @map("file_url")
  status       VerificationStatus @default(pending)
  reviewedBy   String?            @map("reviewed_by") @db.Uuid
  reviewedAt   DateTime?          @map("reviewed_at")
  rejectReason String?            @map("reject_reason") @db.Text
  createdAt    DateTime           @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("verification_documents")
}

model Dispute {
  id          String        @id @default(uuid()) @db.Uuid
  bookingId   String        @unique @map("booking_id") @db.Uuid
  initiatorId String        @map("initiator_id") @db.Uuid
  reason      String        @db.Text
  status      DisputeStatus @default(open)
  resolution  String?       @db.Text
  resolvedBy  String?       @map("resolved_by") @db.Uuid
  resolvedAt  DateTime?     @map("resolved_at")
  createdAt   DateTime      @default(now()) @map("created_at")

  booking  Booking          @relation(fields: [bookingId], references: [id])
  initiator User            @relation(fields: [initiatorId], references: [id])
  messages DisputeMessage[]

  @@index([status])
  @@map("disputes")
}

model DisputeMessage {
  id        String   @id @default(uuid()) @db.Uuid
  disputeId String   @map("dispute_id") @db.Uuid
  senderId  String   @map("sender_id") @db.Uuid
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  dispute Dispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  @@index([disputeId])
  @@map("dispute_messages")
}

model Favorite {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  gigId     String   @map("gig_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  gig  Gig  @relation(fields: [gigId], references: [id], onDelete: Cascade)

  @@unique([userId, gigId])
  @@map("favorites")
}

model PushSubscription {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  endpoint  String   @db.Text
  p256dh    String
  auth      String
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

model Coupon {
  id            String    @id @default(uuid()) @db.Uuid
  code          String    @unique
  discountType  String    @map("discount_type") // "percentage" or "fixed"
  discountValue Float     @map("discount_value")
  maxUses       Int?      @map("max_uses")
  usedCount     Int       @default(0) @map("used_count")
  minOrderValue Float?    @map("min_order_value")
  expiresAt     DateTime? @map("expires_at")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")

  @@map("coupons")
}

model Referral {
  id           String    @id @default(uuid()) @db.Uuid
  referrerId   String    @map("referrer_id") @db.Uuid
  referredId   String?   @unique @map("referred_id") @db.Uuid
  code         String    @unique
  rewardAmount Float     @default(0) @map("reward_amount")
  rewardPaid   Boolean   @default(false) @map("reward_paid")
  createdAt    DateTime  @default(now()) @map("created_at")

  referrer User  @relation("Referrals", fields: [referrerId], references: [id])
  referred User? @relation("ReferredBy", fields: [referredId], references: [id])

  @@index([referrerId])
  @@map("referrals")
}

model PortfolioItem {
  id          String   @id @default(uuid()) @db.Uuid
  providerId  String   @map("provider_id") @db.Uuid
  title       String
  description String?  @db.Text
  imageUrl    String   @map("image_url")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  provider User @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@map("portfolio_items")
}
