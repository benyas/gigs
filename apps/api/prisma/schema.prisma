generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  client
  provider
  admin
}

enum GigStatus {
  draft
  active
  paused
  archived
}

enum BookingStatus {
  pending
  accepted
  in_progress
  completed
  cancelled
  disputed
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  phone        String   @unique
  email        String?  @unique
  passwordHash String?  @map("password_hash")
  role         UserRole @default(client)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  profile         Profile?
  gigs            Gig[]
  bookingsAsClient Booking[] @relation("ClientBookings")
  reviewsGiven    Review[]  @relation("ReviewsGiven")
  reviewsReceived Review[]  @relation("ReviewsReceived")

  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Profile {
  id         String  @id @default(uuid()) @db.Uuid
  userId     String  @unique @map("user_id") @db.Uuid
  name       String
  avatarUrl  String? @map("avatar_url")
  bio        String? @db.Text
  cityId     String? @map("city_id") @db.Uuid
  isVerified Boolean @default(false) @map("is_verified")
  ratingAvg  Float   @default(0) @map("rating_avg")
  ratingCount Int    @default(0) @map("rating_count")

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  city City? @relation(fields: [cityId], references: [id])

  @@index([cityId])
  @@index([ratingAvg])
  @@map("profiles")
}

model City {
  id       String @id @default(uuid()) @db.Uuid
  name     String @unique
  region   String

  profiles Profile[]
  gigs     Gig[]

  @@index([region])
  @@map("cities")
}

model Category {
  id   String @id @default(uuid()) @db.Uuid
  name String @unique
  slug String @unique
  icon String

  gigs Gig[]

  @@map("categories")
}

model Gig {
  id          String    @id @default(uuid()) @db.Uuid
  providerId  String    @map("provider_id") @db.Uuid
  categoryId  String    @map("category_id") @db.Uuid
  title       String
  slug        String    @unique
  description String    @db.Text
  basePrice   Float     @map("base_price")
  cityId      String    @map("city_id") @db.Uuid
  status      GigStatus @default(draft)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  provider  User      @relation(fields: [providerId], references: [id], onDelete: Cascade)
  category  Category  @relation(fields: [categoryId], references: [id])
  city      City      @relation(fields: [cityId], references: [id])
  media     GigMedia[]
  bookings  Booking[]

  @@index([providerId])
  @@index([categoryId])
  @@index([cityId])
  @@index([status])
  @@index([basePrice])
  @@index([createdAt])
  @@map("gigs")
}

model GigMedia {
  id        String @id @default(uuid()) @db.Uuid
  gigId     String @map("gig_id") @db.Uuid
  url       String
  sortOrder Int    @default(0) @map("sort_order")

  gig Gig @relation(fields: [gigId], references: [id], onDelete: Cascade)

  @@index([gigId])
  @@map("gig_media")
}

model Booking {
  id          String        @id @default(uuid()) @db.Uuid
  gigId       String        @map("gig_id") @db.Uuid
  clientId    String        @map("client_id") @db.Uuid
  scheduledAt DateTime      @map("scheduled_at")
  address     String
  notes       String?       @db.Text
  status      BookingStatus @default(pending)
  totalPrice  Float         @map("total_price")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  gig    Gig     @relation(fields: [gigId], references: [id])
  client User    @relation("ClientBookings", fields: [clientId], references: [id])
  review Review?

  @@index([gigId])
  @@index([clientId])
  @@index([status])
  @@index([scheduledAt])
  @@map("bookings")
}

model Review {
  id         String   @id @default(uuid()) @db.Uuid
  bookingId  String   @unique @map("booking_id") @db.Uuid
  clientId   String   @map("client_id") @db.Uuid
  providerId String   @map("provider_id") @db.Uuid
  rating     Int
  comment    String   @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  booking  Booking @relation(fields: [bookingId], references: [id])
  client   User    @relation("ReviewsGiven", fields: [clientId], references: [id])
  provider User    @relation("ReviewsReceived", fields: [providerId], references: [id])

  @@index([providerId])
  @@index([clientId])
  @@index([rating])
  @@map("reviews")
}
