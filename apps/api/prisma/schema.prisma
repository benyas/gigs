generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  client
  provider
  admin
}

enum GigStatus {
  draft
  active
  paused
  archived
}

enum BookingStatus {
  pending
  accepted
  in_progress
  completed
  cancelled
  disputed
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  phone        String   @unique
  email        String?  @unique
  passwordHash String?  @map("password_hash")
  role         UserRole @default(client)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  profile         Profile?
  gigs            Gig[]
  bookingsAsClient Booking[] @relation("ClientBookings")
  reviewsGiven    Review[]  @relation("ReviewsGiven")
  reviewsReceived Review[]  @relation("ReviewsReceived")
  clientConversations   Conversation[] @relation("ClientConversations")
  providerConversations Conversation[] @relation("ProviderConversations")
  sentMessages    Message[]       @relation("SentMessages")
  notifications   Notification[]
  availability    Availability[]

  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Profile {
  id         String  @id @default(uuid()) @db.Uuid
  userId     String  @unique @map("user_id") @db.Uuid
  name       String
  avatarUrl  String? @map("avatar_url")
  bio        String? @db.Text
  cityId     String? @map("city_id") @db.Uuid
  isVerified Boolean @default(false) @map("is_verified")
  ratingAvg  Float   @default(0) @map("rating_avg")
  ratingCount Int    @default(0) @map("rating_count")

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  city City? @relation(fields: [cityId], references: [id])

  @@index([cityId])
  @@index([ratingAvg])
  @@map("profiles")
}

model City {
  id       String @id @default(uuid()) @db.Uuid
  name     String @unique
  region   String

  profiles Profile[]
  gigs     Gig[]

  @@index([region])
  @@map("cities")
}

model Category {
  id   String @id @default(uuid()) @db.Uuid
  name String @unique
  slug String @unique
  icon String

  gigs Gig[]

  @@map("categories")
}

model Gig {
  id          String    @id @default(uuid()) @db.Uuid
  providerId  String    @map("provider_id") @db.Uuid
  categoryId  String    @map("category_id") @db.Uuid
  title       String
  slug        String    @unique
  description String    @db.Text
  basePrice   Float     @map("base_price")
  cityId      String    @map("city_id") @db.Uuid
  status      GigStatus @default(draft)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  provider  User      @relation(fields: [providerId], references: [id], onDelete: Cascade)
  category  Category  @relation(fields: [categoryId], references: [id])
  city      City      @relation(fields: [cityId], references: [id])
  media     GigMedia[]
  bookings  Booking[]

  @@index([providerId])
  @@index([categoryId])
  @@index([cityId])
  @@index([status])
  @@index([basePrice])
  @@index([createdAt])
  @@map("gigs")
}

model GigMedia {
  id        String @id @default(uuid()) @db.Uuid
  gigId     String @map("gig_id") @db.Uuid
  url       String
  sortOrder Int    @default(0) @map("sort_order")

  gig Gig @relation(fields: [gigId], references: [id], onDelete: Cascade)

  @@index([gigId])
  @@map("gig_media")
}

model Booking {
  id           String        @id @default(uuid()) @db.Uuid
  gigId        String        @map("gig_id") @db.Uuid
  clientId     String        @map("client_id") @db.Uuid
  scheduledAt  DateTime      @map("scheduled_at")
  address      String
  notes        String?       @db.Text
  status       BookingStatus @default(pending)
  totalPrice   Float         @map("total_price")
  cancelReason String?       @map("cancel_reason") @db.Text
  cancelledBy  String?       @map("cancelled_by") @db.Uuid
  cancelledAt  DateTime?     @map("cancelled_at")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  gig          Gig           @relation(fields: [gigId], references: [id])
  client       User          @relation("ClientBookings", fields: [clientId], references: [id])
  review       Review?
  conversation Conversation?

  @@index([gigId])
  @@index([clientId])
  @@index([status])
  @@index([scheduledAt])
  @@map("bookings")
}

model Review {
  id              String   @id @default(uuid()) @db.Uuid
  bookingId       String   @unique @map("booking_id") @db.Uuid
  clientId        String   @map("client_id") @db.Uuid
  providerId      String   @map("provider_id") @db.Uuid
  rating          Int
  comment         String   @db.Text
  providerReply   String?  @map("provider_reply") @db.Text
  providerReplyAt DateTime? @map("provider_reply_at")
  createdAt       DateTime @default(now()) @map("created_at")

  booking  Booking @relation(fields: [bookingId], references: [id])
  client   User    @relation("ReviewsGiven", fields: [clientId], references: [id])
  provider User    @relation("ReviewsReceived", fields: [providerId], references: [id])

  @@index([providerId])
  @@index([clientId])
  @@index([rating])
  @@map("reviews")
}

model Conversation {
  id        String   @id @default(uuid()) @db.Uuid
  bookingId String?  @unique @map("booking_id") @db.Uuid
  clientId  String   @map("client_id") @db.Uuid
  providerId String  @map("provider_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  booking  Booking?  @relation(fields: [bookingId], references: [id])
  client   User      @relation("ClientConversations", fields: [clientId], references: [id])
  provider User      @relation("ProviderConversations", fields: [providerId], references: [id])
  messages Message[]

  @@unique([clientId, providerId])
  @@index([clientId])
  @@index([providerId])
  @@index([updatedAt])
  @@map("conversations")
}

model Message {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @map("conversation_id") @db.Uuid
  senderId       String   @map("sender_id") @db.Uuid
  content        String   @db.Text
  isRead         Boolean  @default(false) @map("is_read")
  createdAt      DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SentMessages", fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  type      String
  title     String
  body      String   @db.Text
  link      String?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

model Availability {
  id         String @id @default(uuid()) @db.Uuid
  providerId String @map("provider_id") @db.Uuid
  dayOfWeek  Int    @map("day_of_week") // 0=Sunday, 6=Saturday
  startTime  String @map("start_time")  // "09:00"
  endTime    String @map("end_time")    // "18:00"
  isActive   Boolean @default(true) @map("is_active")

  provider User @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, dayOfWeek])
  @@index([providerId])
  @@map("availabilities")
}
